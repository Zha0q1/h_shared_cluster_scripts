#!/bin/bash
  
export OMPI_COMM_WORLD_RANK=${PMIX_RANK}
export OMPI_COMM_WORLD_SIZE=${SLURM_NTASKS}
export OMPI_COMM_WORLD_LOCAL_SIZE=$((SLURM_NTASKS / SLURM_NNODES))
export OMPI_COMM_WORLD_LOCAL_RANK=$((PMIX_RANK % OMPI_COMM_WORLD_LOCAL_SIZE))
export OMPI_COMM_WORLD_NODE_RANK=$((PMIX_RANK / $OMPI_COMM_WORLD_LOCAL_SIZE))

export SAGEMAKER_INSTANCE_TYPE="ml.p4d.24xlarge"
export NCCL_SOCKET_IFNAME="^lo,docker"

export FI_EFA_USE_DEVICE_RDMA=1

# PT Backend
export MASTER_ADDR=$master
export MASTER_PORT='12345'
export RANK=${OMPI_COMM_WORLD_RANK}
export WORLD_SIZE=${OMPI_COMM_WORLD_SIZE}
export LOCAL_RANK=${OMPI_COMM_WORLD_LOCAL_RANK}

export TRAINING_JOB_NAME="training-job"
export TRAINING_JOB_ARN="job-arn"

$@

